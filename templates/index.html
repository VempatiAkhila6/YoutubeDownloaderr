<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Downloader</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .error { color: #dc2626; }
        .success { color: #059669; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen font-sans">
    <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-md">
        <h1 class="text-2xl font-bold mb-4 text-center">YouTube Downloader</h1>
        <form id="download-form" class="space-y-4" aria-label="YouTube Download Form">
            <div>
                <label for="url" class="block text-sm font-medium">YouTube URL</label>
                <input type="url" id="url" name="url" placeholder="https://www.youtube.com/watch?v=..." class="w-full p-2 border rounded mt-1" required aria-describedby="url-error" />
                <p id="url-error" class="text-sm error hidden mt-1" role="alert"></p>
            </div>
            <div id="video-info" class="hidden space-y-2 p-3 bg-gray-50 rounded">
                <img id="thumbnail" src="" alt="Video thumbnail" class="w-20 h-12 object-cover rounded" />
                <p id="title" class="text-sm font-medium"></p>
                <p id="duration" class="text-xs text-gray-500"></p>
            </div>
            <div>
                <label for="format" class="block text-sm font-medium">Format</label>
                <select id="format" name="format" class="w-full p-2 border rounded mt-1" aria-label="Download format">
                    <option value="mp4">MP4 (Video)</option>
                    <option value="mp3">MP3 (Audio)</option>
                </select>
            </div>
            <div id="resolution-section">
                <label for="resolution" class="block text-sm font-medium">Resolution</label>
                <select id="resolution" name="resolution" class="w-full p-2 border rounded mt-1" aria-label="Video resolution">
                    <option value="720p">720p</option>
                    <option value="360p">360p</option>
                    <option value="240p">240p</option>
                </select>
            </div>
            <button type="submit" id="download-btn" class="w-full bg-blue-600 text-white p-2 rounded hover:bg-blue-700 disabled:bg-gray-400 flex items-center justify-center space-x-2" aria-label="Start download">
                <span>Start Download</span>
            </button>
        </form>
        <div id="progress-section" class="mt-4 hidden">
            <div class="bg-gray-200 rounded h-2.5">
                <div id="progress-bar" class="bg-blue-600 h-2.5 rounded" style="width: 0%" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
            <p id="progress-text" class="text-sm text-center mt-1">0%</p>
        </div>
        <p id="status" class="text-sm text-center mt-4 fade-in" role="alert"></p>
        <p class="text-xs text-gray-500 mt-4 text-center">
            Use this tool responsibly. Ensure you have permission to download content. Comply with YouTube's <a href="https://www.youtube.com/t/terms" class="underline" target="_blank">Terms of Service</a>.
        </p>
    </div>

    <script>
        const form = document.getElementById('download-form');
        const urlInput = document.getElementById('url');
        const urlError = document.getElementById('url-error');
        const videoInfo = document.getElementById('video-info');
        const thumbnail = document.getElementById('thumbnail');
        const title = document.getElementById('title');
        const duration = document.getElementById('duration');
        const formatSelect = document.getElementById('format');
        const resolutionSection = document.getElementById('resolution-section');
        const downloadBtn = document.getElementById('download-btn');
        const progressSection = document.getElementById('progress-section');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const statusText = document.getElementById('status');

        // Toggle resolution section based on format
        formatSelect.addEventListener('change', () => {
            resolutionSection.classList.toggle('hidden', formatSelect.value === 'mp3');
        });

        // Validate URL and fetch video info
        urlInput.addEventListener('input', async () => {
            const url = urlInput.value.trim();
            urlError.classList.add('hidden');
            videoInfo.classList.add('hidden');

            if (!url || !/^(https?:\/\/)?(www\.)?(youtube\.com|youtu\.be)\//.test(url)) {
                urlError.textContent = 'Please enter a valid YouTube URL';
                urlError.classList.remove('hidden');
                return;
            }

            try {
                const res = await fetch('/video_info', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url })
                });
                const data = await res.json();
                if (data.error) {
                    urlError.textContent = data.error;
                    urlError.classList.remove('hidden');
                    return;
                }
                title.textContent = data.title;
                duration.textContent = `Duration: ${data.duration}`;
                thumbnail.src = data.thumbnail;
                videoInfo.classList.remove('hidden');
            } catch (e) {
                urlError.textContent = 'Failed to fetch video info';
                urlError.classList.remove('hidden');
            }
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (downloadBtn.disabled) return;

            downloadBtn.disabled = true;
            downloadBtn.innerHTML = '<svg class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span>Processing...</span>';
            statusText.textContent = 'Starting download...';
            progressSection.classList.remove('hidden');
            progressBar.style.width = '0%';
            progressText.textContent = '0%';

            try {
                const formData = new FormData(form);
                const format = formData.get('format');
                const res = await fetch('/download', { method: 'POST', body: formData });
                const data = await res.json();
                if (!res.ok || data.error) {
                    throw new Error(data.error || 'Failed to start download');
                }

                const sessionId = data.session_id;
                const interval = setInterval(async () => {
                    try {
                        const res = await fetch(`/progress?session_id=${sessionId}`);
                        const data = await res.json();
                        if (data.error) {
                            throw new Error(data.error);
                        }

                        progressBar.style.width = `${data.percentage}%`;
                        progressBar.setAttribute('aria-valuenow', data.percentage);
                        progressText.textContent = `${Math.round(data.percentage)}%`;
                        statusText.textContent = data.status || 'Processing...';

                        if (data.status === 'Downloaded') {
                            clearInterval(interval);
                            statusText.textContent = 'Download complete. Saving file...';
                            window.location.href = `/download_file?session_id=${sessionId}&format=${format}`;
                            setTimeout(() => {
                                downloadBtn.disabled = false;
                                downloadBtn.innerHTML = '<span>Start Download</span>';
                                progressSection.classList.add('hidden');
                                statusText.textContent = '';
                            }, 3000);
                        }
                    } catch (e) {
                        clearInterval(interval);
                        statusText.classList.add('error');
                        statusText.textContent = `Error: ${e.message}`;
                        downloadBtn.disabled = false;
                        downloadBtn.innerHTML = '<span>Start Download</span>';
                        setTimeout(() => progressSection.classList.add('hidden'), 3000);
                    }
                }, 1000);
            } catch (e) {
                statusText.classList.add('error');
                statusText.textContent = `Error: ${e.message}`;
                downloadBtn.disabled = false;
                downloadBtn.innerHTML = '<span>Start Download</span>';
                setTimeout(() => progressSection.classList.add('hidden'), 3000);
            }
        });
    </script>
</body>
</html>
